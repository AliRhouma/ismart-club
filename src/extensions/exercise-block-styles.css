import { Node, mergeAttributes } from '@tiptap/core';
import { ReactNodeViewRenderer, NodeViewWrapper } from '@tiptap/react';
import { useState } from 'react';
import {
  Plus, Trash2, Settings, Check, X,
  FileText, Monitor,
  BookOpen, Pencil, CheckSquare, AlignLeft,
  ChevronDown, ChevronUp,
} from 'lucide-react';

// ─────────────────────────────────────────────────────────────────────────────
// TYPES
// ─────────────────────────────────────────────────────────────────────────────
type QuestionType = 'mcq' | 'short' | 'long' | 'truefalse' | 'fill';

interface Choice { id: string; text: string; correct: boolean; }
interface Question {
  id: string; type: QuestionType; prompt: string;
  choices: Choice[]; lines: number; hint: string;
}
interface ExerciseAttrs {
  title: string; instructions: string; subject: string; level: string;
  accentColor: string; questions: Question[];
  viewMode: 'screen' | 'document'; showAnswers: boolean; exerciseNumber: string;
}

// ─────────────────────────────────────────────────────────────────────────────
// HELPERS
// ─────────────────────────────────────────────────────────────────────────────
const ACCENT_COLORS = [
  { value: '#0091ff', label: 'Blue'    },
  { value: '#10b981', label: 'Green'   },
  { value: '#f59e0b', label: 'Amber'   },
  { value: '#ef4444', label: 'Red'     },
  { value: '#8b5cf6', label: 'Purple'  },
  { value: '#0f766e', label: 'Teal'    },
  { value: '#1a3a6b', label: 'Navy'    },
  { value: '#1f2937', label: 'Slate'   },
];

const QUESTION_TYPES: { value: QuestionType; label: string }[] = [
  { value: 'mcq',       label: 'Multiple choice' },
  { value: 'truefalse', label: 'True / False'    },
  { value: 'short',     label: 'Short answer'    },
  { value: 'long',      label: 'Long answer'     },
  { value: 'fill',      label: 'Fill in blank'   },
];

const uid = () => Math.random().toString(36).slice(2, 8);

function makeQuestion(type: QuestionType = 'mcq'): Question {
  return {
    id: uid(), type, prompt: '', hint: '', lines: type === 'long' ? 4 : 2,
    choices:
      type === 'mcq'       ? [{ id: uid(), text: '', correct: false }, { id: uid(), text: '', correct: false }]
      : type === 'truefalse' ? [{ id: uid(), text: 'True', correct: false }, { id: uid(), text: 'False', correct: false }]
      : [],
  };
}

// ─────────────────────────────────────────────────────────────────────────────
// SCREEN VIEW
// ─────────────────────────────────────────────────────────────────────────────
const ScreenView = ({ attrs, onEdit, onToggleAnswers }: {
  attrs: ExerciseAttrs; onEdit: () => void; onToggleAnswers: () => void;
}) => {
  const { title, instructions, subject, level, accentColor, questions, showAnswers, exerciseNumber } = attrs;
  const [openHints, setOpenHints] = useState<Record<string, boolean>>({});
  const toggleHint = (id: string) => setOpenHints(p => ({ ...p, [id]: !p[id] }));

  return (
    <div className="ex-screen-wrap">
      {/* ── Header card ── */}
      <div className="ex-screen-header" style={{ borderLeftColor: accentColor }}>
        <div className="ex-screen-header-top">
          <div className="ex-screen-badges">
            {exerciseNumber && (
              <span className="ex-screen-badge-num" style={{ background: accentColor }}>
                Exercise {exerciseNumber}
              </span>
            )}
            {subject && <span className="ex-screen-badge">{subject}</span>}
            {level   && <span className="ex-screen-badge">{level}</span>}
          </div>
          <div className="ex-screen-hdr-actions">
            <button
              className={`ex-screen-action-btn ${showAnswers ? 'active' : ''}`}
              style={showAnswers ? { color: accentColor, borderColor: accentColor } : {}}
              onClick={onToggleAnswers}
            >
              <CheckSquare size={12} />
              {showAnswers ? 'Hide answers' : 'Show answers'}
            </button>
            <button className="ex-screen-action-btn" onClick={onEdit}>
              <Settings size={12} /> Edit
            </button>
          </div>
        </div>
        <h3 className="ex-screen-title" style={{ color: accentColor }}>
          {title || 'Untitled Exercise'}
        </h3>
        {instructions && <p className="ex-screen-instructions">{instructions}</p>}
      </div>

      {/* ── Questions ── */}
      <div className="ex-screen-questions">
        {questions.length === 0 && (
          <div className="ex-screen-empty">No questions yet — click Edit to add some.</div>
        )}
        {questions.map((q, qi) => (
          <div key={q.id} className="ex-screen-qcard">
            <div className="ex-screen-qnum" style={{ background: accentColor }}>{qi + 1}</div>
            <div className="ex-screen-qbody">
              <span className="ex-screen-qtype-tag">
                {QUESTION_TYPES.find(t => t.value === q.type)?.label}
              </span>
              <p className="ex-screen-qprompt">
                {q.prompt || <em style={{ color: '#9ca3af' }}>No question text</em>}
              </p>

              {/* MCQ / T-F */}
              {(q.type === 'mcq' || q.type === 'truefalse') && (
                <div className="ex-screen-choices">
                  {q.choices.map((c, ci) => (
                    <div
                      key={c.id}
                      className={`ex-screen-choice ${showAnswers && c.correct ? 'correct' : ''}`}
                      style={showAnswers && c.correct ? { borderColor: accentColor, background: accentColor + '15' } : {}}
                    >
                      <span className="ex-screen-choice-letter"
                        style={showAnswers && c.correct ? { background: accentColor, color: '#fff' } : {}}>
                        {String.fromCharCode(65 + ci)}
                      </span>
                      <span className="ex-screen-choice-text">{c.text || '…'}</span>
                      {showAnswers && c.correct && <Check size={13} style={{ marginLeft: 'auto', color: accentColor, flexShrink: 0 }} />}
                    </div>
                  ))}
                </div>
              )}

              {/* Answer lines */}
              {(q.type === 'short' || q.type === 'long') && (
                <div className="ex-screen-lines">
                  {Array.from({ length: q.lines }).map((_, i) => <div key={i} className="ex-screen-line" />)}
                </div>
              )}

              {/* Fill blank */}
              {q.type === 'fill' && <div className="ex-screen-fill-box">_______________</div>}

              {/* Hint */}
              {q.hint && (
                <div className="ex-screen-hint-wrap">
                  <button className="ex-screen-hint-toggle" style={{ color: accentColor }} onClick={() => toggleHint(q.id)}>
                    {openHints[q.id] ? <ChevronUp size={11}/> : <ChevronDown size={11}/>} Hint
                  </button>
                  {openHints[q.id] && (
                    <div className="ex-screen-hint-text" style={{ borderLeftColor: accentColor }}>
                      {q.hint}
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// ─────────────────────────────────────────────────────────────────────────────
// DOCUMENT VIEW
// ─────────────────────────────────────────────────────────────────────────────
const DocumentView = ({ attrs, onEdit }: { attrs: ExerciseAttrs; onEdit: () => void }) => {
  const { title, instructions, subject, level, accentColor, questions, showAnswers, exerciseNumber } = attrs;

  return (
    <div className="ex-doc-wrap">
      <button className="ex-doc-edit-btn" onClick={onEdit} contentEditable={false}>
        <Settings size={11} /> Edit
      </button>

      {/* ── Document header ── */}
      <div className="ex-doc-header">
        <div className="ex-doc-accent-bar" style={{ background: accentColor }} />
        <div className="ex-doc-header-body">
          {(subject || level) && (
            <div className="ex-doc-meta-row">
              {subject && <span className="ex-doc-meta-chip">{subject}</span>}
              {level   && <span className="ex-doc-meta-chip">{level}</span>}
            </div>
          )}
          <h3 className="ex-doc-title">
            {exerciseNumber && (
              <span className="ex-doc-exnum" style={{ color: accentColor }}>
                Exercice {exerciseNumber} —{' '}
              </span>
            )}
            {title || 'Untitled Exercise'}
          </h3>
          {instructions && (
            <p className="ex-doc-instructions">
              <span className="ex-doc-instructions-label">Instructions :</span> {instructions}
            </p>
          )}
        </div>
      </div>

      {/* ── Questions ── */}
      <div className="ex-doc-questions">
        {questions.length === 0 && <p className="ex-doc-empty">No questions added yet.</p>}
        {questions.map((q, qi) => (
          <div key={q.id} className="ex-doc-question">
            <div className="ex-doc-q-row">
              <span className="ex-doc-q-num" style={{ color: accentColor }}>
                {qi + 1}.
              </span>
              <div className="ex-doc-q-content">
                <p className="ex-doc-q-prompt">
                  {q.prompt || <em className="ex-doc-q-empty">Question text…</em>}
                  {q.type === 'fill' && <span className="ex-doc-blank"> ___________________</span>}
                </p>

                {/* MCQ list */}
                {(q.type === 'mcq' || q.type === 'truefalse') && (
                  <ol className="ex-doc-choices" type="A">
                    {q.choices.map((c) => (
                      <li
                        key={c.id}
                        className={`ex-doc-choice ${showAnswers && c.correct ? 'correct' : ''}`}
                        style={showAnswers && c.correct ? { color: accentColor, fontWeight: 700 } : {}}
                      >
                        {c.text || '…'}
                        {showAnswers && c.correct && <span className="ex-doc-tick"> ✓</span>}
                      </li>
                    ))}
                  </ol>
                )}

                {/* Answer lines */}
                {(q.type === 'short' || q.type === 'long') && (
                  <div className="ex-doc-answer-lines">
                    {Array.from({ length: q.lines }).map((_, i) => <div key={i} className="ex-doc-answer-line" />)}
                  </div>
                )}

                {/* Hint when answers shown */}
                {q.hint && showAnswers && (
                  <p className="ex-doc-hint"><strong>Hint :</strong> {q.hint}</p>
                )}
              </div>
            </div>
            {qi < questions.length - 1 && <div className="ex-doc-divider" />}
          </div>
        ))}
      </div>

      {/* ── Footer score ── */}
      <div className="ex-doc-footer">
        <span className="ex-doc-score-label">Score :</span>
        <span className="ex-doc-score-line" />
        <span className="ex-doc-score-total">/ {questions.length}</span>
      </div>
    </div>
  );
};

// ─────────────────────────────────────────────────────────────────────────────
// EDIT PANEL
// ─────────────────────────────────────────────────────────────────────────────
const EditPanel = ({ attrs, onSave, onCancel }: {
  attrs: ExerciseAttrs;
  onSave: (p: Partial<ExerciseAttrs>) => void;
  onCancel: () => void;
}) => {
  const [title, setTitle]               = useState(attrs.title);
  const [instructions, setInstructions] = useState(attrs.instructions);
  const [subject, setSubject]           = useState(attrs.subject);
  const [level, setLevel]               = useState(attrs.level);
  const [accentColor, setAccentColor]   = useState(attrs.accentColor);
  const [exNum, setExNum]               = useState(attrs.exerciseNumber);
  const [questions, setQuestions]       = useState<Question[]>(
    attrs.questions.length ? attrs.questions : [makeQuestion('mcq')]
  );

  const addQ = () => setQuestions(p => [...p, makeQuestion('mcq')]);
  const removeQ = (id: string) => setQuestions(p => p.filter(q => q.id !== id));
  const updateQ = (id: string, patch: Partial<Question>) =>
    setQuestions(p => p.map(q => q.id === id ? { ...q, ...patch } : q));
  const changeType = (id: string, type: QuestionType) => {
    const fresh = makeQuestion(type);
    setQuestions(p => p.map(q => q.id === id ? { ...fresh, id: q.id, prompt: q.prompt } : q));
  };
  const addChoice = (qid: string) =>
    setQuestions(p => p.map(q => q.id === qid ? { ...q, choices: [...q.choices, { id: uid(), text: '', correct: false }] } : q));
  const removeChoice = (qid: string, cid: string) =>
    setQuestions(p => p.map(q => q.id === qid ? { ...q, choices: q.choices.filter(c => c.id !== cid) } : q));
  const updateChoice = (qid: string, cid: string, patch: Partial<Choice>) =>
    setQuestions(p => p.map(q => q.id === qid ? { ...q, choices: q.choices.map(c => c.id === cid ? { ...c, ...patch } : c) } : q));
  const setCorrect = (qid: string, cid: string) =>
    setQuestions(p => p.map(q => q.id === qid ? { ...q, choices: q.choices.map(c => ({ ...c, correct: c.id === cid })) } : q));

  return (
    <div className="ex-edit-wrap" contentEditable={false}>
      {/* Meta */}
      <div className="ex-edit-section">
        <p className="ex-edit-section-title">Exercise details</p>
        <div className="ex-edit-row-3">
          <div>
            <label className="ex-edit-label">Exercise #</label>
            <input className="ex-edit-input" value={exNum} onChange={e => setExNum(e.target.value)} placeholder="1" />
          </div>
          <div>
            <label className="ex-edit-label">Subject</label>
            <input className="ex-edit-input" value={subject} onChange={e => setSubject(e.target.value)} placeholder="Maths" />
          </div>
          <div>
            <label className="ex-edit-label">Level</label>
            <input className="ex-edit-input" value={level} onChange={e => setLevel(e.target.value)} placeholder="Grade 8" />
          </div>
        </div>
        <label className="ex-edit-label">Title</label>
        <input className="ex-edit-input" value={title} onChange={e => setTitle(e.target.value)} placeholder="Exercise title…" />
        <label className="ex-edit-label" style={{ marginTop: 10 }}>Instructions</label>
        <textarea className="ex-edit-textarea" value={instructions} onChange={e => setInstructions(e.target.value)} placeholder="Answer all questions…" rows={2} />
        <label className="ex-edit-label" style={{ marginTop: 10 }}>Accent color</label>
        <div className="ex-edit-colors">
          {ACCENT_COLORS.map(c => (
            <button
              key={c.value}
              className={`ex-edit-color-swatch ${accentColor === c.value ? 'selected' : ''}`}
              style={{ background: c.value }}
              onClick={() => setAccentColor(c.value)}
              title={c.label}
            >
              {accentColor === c.value && <Check size={11} color="#fff" />}
            </button>
          ))}
        </div>
      </div>

      {/* Questions */}
      <div className="ex-edit-section">
        <div className="ex-edit-section-header">
          <p className="ex-edit-section-title">Questions ({questions.length})</p>
          <button className="ex-edit-add-q-btn" style={{ borderColor: accentColor, color: accentColor }} onClick={addQ}>
            <Plus size={13} /> Add question
          </button>
        </div>

        {questions.map((q, qi) => (
          <div key={q.id} className="ex-edit-qblock">
            <div className="ex-edit-qblock-hdr">
              <span className="ex-edit-qblock-num" style={{ background: accentColor }}>Q{qi + 1}</span>
              <select className="ex-edit-select" value={q.type} onChange={e => changeType(q.id, e.target.value as QuestionType)}>
                {QUESTION_TYPES.map(t => <option key={t.value} value={t.value}>{t.label}</option>)}
              </select>
              <button className="ex-edit-remove-btn" onClick={() => removeQ(q.id)}><Trash2 size={13} /></button>
            </div>
            <textarea className="ex-edit-textarea" value={q.prompt} onChange={e => updateQ(q.id, { prompt: e.target.value })} placeholder="Question text…" rows={2} />

            {/* MCQ */}
            {q.type === 'mcq' && (
              <div className="ex-edit-choices">
                {q.choices.map((c, ci) => (
                  <div key={c.id} className="ex-edit-choice-row">
                    <button
                      className={`ex-edit-correct-btn ${c.correct ? 'is-correct' : ''}`}
                      style={c.correct ? { background: accentColor, borderColor: accentColor } : {}}
                      onClick={() => setCorrect(q.id, c.id)}
                      title="Mark as correct"
                    >
                      {c.correct ? <Check size={11} color="#fff" /> : String.fromCharCode(65 + ci)}
                    </button>
                    <input className="ex-edit-input" value={c.text} onChange={e => updateChoice(q.id, c.id, { text: e.target.value })} placeholder={`Choice ${String.fromCharCode(65 + ci)}…`} />
                    <button className="ex-edit-remove-btn" onClick={() => removeChoice(q.id, c.id)} disabled={q.choices.length <= 2}><X size={12} /></button>
                  </div>
                ))}
                <button className="ex-edit-ghost-btn" onClick={() => addChoice(q.id)}><Plus size={12} /> Add choice</button>
              </div>
            )}

            {/* True/False */}
            {q.type === 'truefalse' && (
              <div className="ex-edit-choices">
                {q.choices.map(c => (
                  <div key={c.id} className="ex-edit-choice-row">
                    <button
                      className={`ex-edit-correct-btn ${c.correct ? 'is-correct' : ''}`}
                      style={c.correct ? { background: accentColor, borderColor: accentColor } : {}}
                      onClick={() => setCorrect(q.id, c.id)}
                    >
                      {c.correct ? <Check size={11} color="#fff" /> : c.text[0]}
                    </button>
                    <span className="ex-edit-tf-label">{c.text}</span>
                  </div>
                ))}
              </div>
            )}

            {/* Lines */}
            {(q.type === 'short' || q.type === 'long') && (
              <div className="ex-edit-inline-row">
                <label className="ex-edit-label">Answer lines</label>
                <input type="number" className="ex-edit-input ex-edit-input-sm" value={q.lines} min={1} max={10} onChange={e => updateQ(q.id, { lines: Number(e.target.value) })} />
              </div>
            )}

            <div style={{ marginTop: 8 }}>
              <label className="ex-edit-label">Hint (optional)</label>
              <input className="ex-edit-input" value={q.hint} onChange={e => updateQ(q.id, { hint: e.target.value })} placeholder="Optional hint…" />
            </div>
          </div>
        ))}
      </div>

      {/* Actions */}
      <div className="ex-edit-actions">
        <button className="ex-edit-save-btn" style={{ background: accentColor }}
          onClick={() => onSave({ title, instructions, subject, level, accentColor, questions, exerciseNumber: exNum })}>
          <Check size={14} /> Save Exercise
        </button>
        <button className="ex-edit-cancel-btn" onClick={onCancel}><X size={14} /> Cancel</button>
      </div>
    </div>
  );
};

// ─────────────────────────────────────────────────────────────────────────────
// ROOT COMPONENT
// ─────────────────────────────────────────────────────────────────────────────
const ExerciseBlockComponent = ({ node, updateAttributes }: any) => {
  const attrs = node.attrs as ExerciseAttrs;
  const [isEditing, setIsEditing] = useState(!attrs.title && attrs.questions.length === 0);

  return (
    <NodeViewWrapper as="div" className="exercise-block-wrapper">
      {!isEditing && (
        <div className="ex-view-switcher" contentEditable={false}>
          <button
            className={`ex-view-btn ${attrs.viewMode === 'screen' ? 'active' : ''}`}
            onClick={() => updateAttributes({ viewMode: 'screen' })}
          >
            <Monitor size={13} /> Screen
          </button>
          <button
            className={`ex-view-btn ${attrs.viewMode === 'document' ? 'active' : ''}`}
            onClick={() => updateAttributes({ viewMode: 'document' })}
          >
            <FileText size={13} /> Document
          </button>
        </div>
      )}

      {isEditing ? (
        <EditPanel attrs={attrs} onSave={p => { updateAttributes(p); setIsEditing(false); }} onCancel={() => setIsEditing(false)} />
      ) : attrs.viewMode === 'document' ? (
        <DocumentView attrs={attrs} onEdit={() => setIsEditing(true)} />
      ) : (
        <ScreenView attrs={attrs} onEdit={() => setIsEditing(true)} onToggleAnswers={() => updateAttributes({ showAnswers: !attrs.showAnswers })} />
      )}
    </NodeViewWrapper>
  );
};

// ─────────────────────────────────────────────────────────────────────────────
// NODE DEFINITION
// ─────────────────────────────────────────────────────────────────────────────
export const ExerciseBlock = Node.create({
  name: 'exerciseBlock',
  group: 'block',
  atom: true,

  addAttributes() {
    return {
      title:          { default: '' },
      instructions:   { default: '' },
      subject:        { default: '' },
      level:          { default: '' },
      accentColor:    { default: '#0091ff' },
      questions:      { default: [] },
      viewMode:       { default: 'screen' },
      showAnswers:    { default: false },
      exerciseNumber: { default: '' },
    };
  },

  parseHTML() { return [{ tag: 'div[data-type="exercise-block"]' }]; },
  renderHTML({ HTMLAttributes }) {
    return ['div', mergeAttributes(HTMLAttributes, { 'data-type': 'exercise-block' }), 0];
  },
  addNodeView() { return ReactNodeViewRenderer(ExerciseBlockComponent); },

  addCommands() {
    return {
      setExerciseBlock: () => ({ commands }: any) =>
        commands.insertContent({
          type: this.name,
          attrs: { title: '', instructions: '', subject: '', level: '', accentColor: '#0091ff', questions: [], viewMode: 'screen', showAnswers: false, exerciseNumber: '' },
        }),
    } as any;
  },
});